# clockwork-wdl
 A WDLization + Dockerization of some parts of the *Mycobacterium tuberculosis* toolkit [clockwork](https://github.com/iqbal-lab-org/clockwork), focusing on functions used by [this walkthrough](https://github.com/iqbal-lab-org/clockwork/wiki/Walkthrough-scripts-only). Supports (and sometimes requires) tarball inputs -- please make sure to read the inputs section.

 If you are here looking for a pipeline to decontaminate (and optionally concatenate) your TB FASTQs, please see [decon](https://github.com/aofarrel/decon). If you are looking for a pipeline to decontaminate, call variants, and optionally put your samples on a phylogenetic tree, please see [myco](https://github.com/aofarrel/myco).

## Available Docker images
  * [ashedpotatoes/iqbal-unofficial-clockwork-mirror](https://hub.docker.com/r/ashedpotatoes/iqbal-unofficial-clockwork-mirror) -- unofficial Docker Hub mirror of clockwork's official [the ghcr.io release](https://github.com/iqbal-lab-org/clockwork/pkgs/container/clockwork). Exists only because some WDL executors can fail when pulling ghcr.io containers. Completely unchanged from the official release and follows its tags.
  * [ashedpotatoes/iqbal-clockwork-plus-ref-genomes-slim]() -- official clockwork Docker image but with the typical outputs of [download_tb_reference_files.pl](https://github.com/iqbal-lab-org/clockwork/blob/master/scripts/download_tb_reference_files.pl) and `clockwork reference_prepare` provided inside the image already, **except for the decontamination reference**. This allows you to run `clockwork map_reads` and `clockwork variant_call_one_sample`, and their associated WDL wrappers, without having to pass in hefty reference genome files.
  * [ashedpotatoes/iqbal-clockwork-plus-ref-genomes-cryptic]() -- the slim image plus the 12 GB decontamination reference created by running [download_tb_reference_files.pl](https://github.com/iqbal-lab-org/clockwork/blob/master/scripts/download_tb_reference_files.pl) and `clockwork reference_prepare`. 
  * [ashedpotatoes/iqbal-clockwork-plus-ref-genomes-cdc]() -- the slim image plus the decontamination reference from CDC's varpipe repository.


| docker images                                          | H37Rv ref    | decontamination ref                                                                                                                                                                                                                                                                                                                                                                                                                                                | use case                                                                                                                     | approx. size |
|--------------------------------------------------------|--------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------|--------------|
| ashedpotatoes/iqbal-unofficial-clockwork-mirror        | not included | not included                                                                                                                                                                                                                                                                                                                                                                                                                                                       | you want the official docker image on a non-ghcr.io image repository (some WDL executors can fail when pulling from ghcr.io) | 6 GB         |
| ashedpotatoes/iqbal-clockwork-plus-ref-genomes-slim    | included     | not included                                                                                                                                                                                                                                                                                                                                                                                                                                                       | call variants without using a massive Docker image                                                                           | 6 GB         |
| ashedpotatoes/iqbal-clockwork-plus-ref-genomes-cryptic | included     | included: <ul><li>generated by [download_tb_reference_files.pl](https://github.com/iqbal-lab-org/clockwork/blob/master/scripts/download_tb_reference_files.pl) and `clockwork reference_prepare`</li><li>may change between different versions of clockwork (eg: 0.11.3 uses hg38, 0.12.0 uses CHM13)</li><li>contains Tongue_dorsum contigs</li><li>metadata TSV labels what each contig is (human, viral, NTM, etc) --> different contaminants can be toggled</li><li>includes ~11 GB minimap index</ul> | decontaminate with CRyPTIC's recommended decontamination reference                   | 22 GB        |
| ashedpotatoes/iqbal-clockwork-plus-ref-genomes-cdc     | included     | included: <ui><li>generated by CDC; source files unknown</li><li>does not change between different versions of clockwork</li><li>does not appear to contain Tongue_dorsum contigs</li><li>metadata TSV does not label what each contig is (human, viral, NTM, etc) --> different contaminants cannot be toggled</li><li>does not include ~11 GB minimap index</ul>                                                                                                                                         | decontaminate with CDC varpipe's decontamination reference                           | 13 GB        |


## Supported tasks and workflows
 **Tasks**
 * dl_TB_ref: downloads tuberculosis reference files using [download_tb_reference_files.pl](https://github.com/iqbal-lab-org/clockwork/blob/master/scripts/download_tb_reference_files.pl)
 * gvcf: implementation of `clockwork gvcf_from_minos_and_samtools`
 * map_reads: implementation of `clockwork map_reads`
 * ref_prep: limited implementation of `clockwork reference_prepare`, does not support databases
 * rm_contam: implementation of `clockwork remove_contam`
 * variant_call_one_sample: implementation of `clockwork variant_call_one_sample`

 **Workflows**
 * decontaminate_one_sample: decontaminates and combines a single sample's fastqs
 * gvcf_after_walkthru: converts the output of walkthru (see below) to a gvcf
 * ref_prep-generic: runs a generic ref_prep workflow
 * ref_prep-TB: runs a tuberculosis-specific ref_prep workflow [based on this](https://github.com/iqbal-lab-org/clockwork/wiki/Walkthrough-scripts-only#get-and-index-reference-genomes)
 * walkthru: goes from FASTQ input to minos' adjudicated VCF output

### Skipping steps on walkthru.wdl
 To allow for quicker runs, several workflows have "bluepeter" options. Named after the TV show coining the term "here's one I made earlier," these are files you can insert when running a workflow more than once in order to avoid downloading the same set of files over and over again.
 
  All JSONs are Cromwell-formatted.
  * **walkthru-skip-nothing.json**: Skip nothing
  * **walkthru-skip-refdl.json**: Skip dl_TB_ref, which is the first step of wf-reprep-TB; use this to test index_decontamination_ref and index_H37Rv_reference.
  * **walkthru-skip-ref_prep.json**: Skip wf-ref_prep-TB (including dl_TB_ref); use this to test enaDataGet and (eventually) map_reads
  * **walkthru-skip-ref_prep-and-ena.json**: Skip wf-ref_prep-TB (including dl_TB_ref) and enaDataGet; use this to test map_reads

### Note to local Cromwell users
 My testing indicates that running the ref_prep workflow on a typical laptop setup will not be successful due to processes getting sigkilled thanks to lack of compute resources. You'll know you're having this issue because you will see "killed" and/or a return code of 137 in your Clockwork logs (you likely won't see this in Cromwell's terminal output). You may have some luck increasing Docker's resources or running more than once, but it's probably best to run these once in the cloud, download the results, and then use them as bluepeter inputs from then on (or just run the whole thing in the cloud).

